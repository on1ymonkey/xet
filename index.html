<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nosso Cantinho</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Biblioteca de √≠cones Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        /* Importa as fontes do Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap');
        
        body {
            font-family: 'Poppins', sans-serif;
            /* NOVO: Fundo em degrad√™ lil√°s */
            background-image: linear-gradient(to top left, #f5f3ff, #d8b4fe);
        }

        /* NOVA: Classe para a fonte especial do t√≠tulo */
        .font-title {
            font-family: 'Dancing Script', cursive;
        }

        /* Estilo da barra de rolagem para combinar com o tema fofo */
        #chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        #chat-messages::-webkit-scrollbar-track {
            background: #f3e8ff; /* Fundo da barra de rolagem (violet-100) */
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background: #c084fc; /* Cor da barra (violet-400) */
            border-radius: 4px;
        }
        #chat-messages::-webkit-scrollbar-thumb:hover {
            background: #a855f7; /* Cor ao passar o mouse (violet-500) */
        }
    </style>
</head>
<body class="flex items-center justify-center h-screen p-4">

    <!-- Container principal com efeito de vidro fosco para mostrar o degrad√™ -->
    <div id="app-container" class="w-full max-w-2xl h-full bg-white/60 backdrop-blur-lg rounded-2xl shadow-xl flex flex-col">
        
        <!-- Cabe√ßalho com nova fonte e sem subt√≠tulo -->
        <header class="border-b-2 border-violet-200/50 p-6 text-center">
            <h1 class="font-title text-5xl font-bold text-violet-800">
                Nosso Cantinho
            </h1>
        </header>

        <!-- √Årea de mensagens com fundo claro -->
        <main id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
             <div id="loading-spinner" class="flex flex-col items-center justify-center h-full text-violet-500">
                <i class="ph-fill ph-heart text-5xl animate-pulse"></i>
                <span class="mt-4 text-lg">Conectando nosso cantinho...</span>
            </div>
        </main>

        <!-- Rodap√© e formul√°rio de envio -->
        <footer class="border-t-2 border-violet-200/50 p-4 bg-white/50 rounded-b-2xl">
            <form id="message-form" class="flex items-center space-x-4">
                <input 
                    type="text" 
                    id="message-input" 
                    placeholder="Escreva uma mensagem..." 
                    autocomplete="off"
                    class="flex-1 py-3 px-5 bg-violet-100 border-2 border-transparent rounded-full focus:border-violet-400 text-violet-800 placeholder-violet-400 focus:outline-none transition-colors duration-300"
                    required
                >
                <button 
                    type="submit" 
                    class="bg-pink-400 text-white p-3 rounded-full hover:bg-pink-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-400 transition-all duration-150 flex items-center justify-center w-14 h-14 shadow-lg">
                    <i class="ph-fill ph-heart text-3xl"></i>
                </button>
            </form>
        </footer>
    </div>

    <!-- M√≥dulos do Firebase (A l√≥gica permanece a mesma) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configura√ß√£o do Firebase corrigida com suas chaves.
        const firebaseConfig = {
            apiKey: "AIzaSyAwCdMjW7otJ9zkYQBSRiqa3SW7HQEjiyA",
            authDomain: "chat-7ac83.firebaseapp.com",
            projectId: "chat-7ac83",
            storageBucket: "chat-7ac83.firebasestorage.app",
            messagingSenderId: "1067244815405",
            appId: "1:1067244815405:web:74764d25b23d3388bba4a4",
            measurementId: "G-70P29NMB73"
        };
        
        const appId = 'default-chat-app'; // Usando um ID fixo para o caminho do Firestore

        // --- Inicializa√ß√£o do Firebase (sem altera√ß√µes na l√≥gica) ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUserId = null;

        // --- Elementos do DOM ---
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const chatMessages = document.getElementById('chat-messages');
        const loadingSpinner = document.getElementById('loading-spinner');

        // --- L√≥gica de Autentica√ß√£o e Chat (CORRIGIDA) ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Se o usu√°rio j√° est√° logado, configura o app
                currentUserId = user.uid;
                listenForMessages();
            } else {
                // Se n√£o h√° usu√°rio, tenta fazer o login an√¥nimo diretamente.
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Erro na autentica√ß√£o:", error);
                    loadingSpinner.innerHTML = `<p class="text-red-500 text-center">Ops! N√£o conseguimos nos conectar. Tente atualizar a p√°gina.</p>`;
                }
            }
        });

        function listenForMessages() {
            const messagesCollectionPath = `/artifacts/${appId}/public/data/messages`;
            const messagesRef = collection(db, messagesCollectionPath);
            const q = query(messagesRef);

            onSnapshot(q, (querySnapshot) => {
                if(loadingSpinner) loadingSpinner.style.display = 'none';
                
                const messages = [];
                querySnapshot.forEach((doc) => {
                    messages.push({ id: doc.id, ...doc.data() });
                });

                messages.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
                
                displayMessages(messages);
            }, (error) => {
                console.error("Erro ao buscar mensagens: ", error);
                chatMessages.innerHTML = `<p class="text-red-500 text-center">N√£o foi poss√≠vel carregar as mensagens. Verifique as regras do Firebase.</p>`;
            });
        }

        function displayMessages(messages) {
            chatMessages.innerHTML = '';
            if (messages.length === 0) {
                 chatMessages.innerHTML = `<p class="text-violet-400 text-center">Nenhuma mensagem ainda. Que tal um "oi"? üòä</p>`;
            } else {
                messages.forEach(msg => {
                    const messageElement = document.createElement('div');
                    const isCurrentUser = msg.userId === currentUserId;

                    // Define o estilo dos bal√µes de mensagem
                    messageElement.className = `w-full flex ${isCurrentUser ? 'justify-end' : 'justify-start'}`;
                    
                    const bubbleColor = isCurrentUser ? 'bg-violet-500 text-white' : 'bg-gray-200 text-gray-800';
                    const bubbleRounding = isCurrentUser ? 'rounded-t-2xl rounded-bl-2xl' : 'rounded-t-2xl rounded-br-2xl';

                    messageElement.innerHTML = `
                        <div class="max-w-xs md:max-w-md p-3 px-4 shadow-md ${bubbleColor} ${bubbleRounding}">
                            <p class="break-words">${escapeHTML(msg.text)}</p>
                        </div>
                    `;
                    chatMessages.appendChild(messageElement);
                });
            }
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function sendMessage(e) {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (text && currentUserId) {
                try {
                    const messagesCollectionPath = `/artifacts/${appId}/public/data/messages`;
                    await addDoc(collection(db, messagesCollectionPath), {
                        text: text,
                        userId: currentUserId,
                        createdAt: serverTimestamp()
                    });
                    messageInput.value = '';
                } catch (error) {
                    console.error("Erro ao enviar mensagem: ", error);
                }
            }
        }
        
        function escapeHTML(str) {
            const p = document.createElement('p');
            p.appendChild(document.createTextNode(str));
            return p.innerHTML;
        }

        messageForm.addEventListener('submit', sendMessage);
    </script>
</body>
</html>
